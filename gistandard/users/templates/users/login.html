{% extends 'base.html' %}
{% block title %}登录{% endblock %}
{% block content %}
<form method="post" class="card p-4 mx-auto" style="max-width:400px;">
  <h3 class="mb-3">用户登录</h3>

  <!-- 必须要有CSRF令牌 -->
  {% csrf_token %}

  <!-- 显示消息 -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}
                    alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- 显示表单错误 -->
  {% if form.non_field_errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {% for error in form.non_field_errors %}
        {{ error }}<br>
      {% endfor %}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}

  {% if form.username.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {% for error in form.username.errors %}
        {{ error }}<br>
      {% endfor %}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}

  {% if form.password.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {% for error in form.password.errors %}
        {{ error }}<br>
      {% endfor %}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}

  <div class="mb-3">
    <label class="form-label">工号</label>
    <input type="text" class="form-control" name="username"
           value="{{ form.username.value|default:'' }}" required>
  </div>
  <div class="mb-3">
    <label class="form-label">密码</label>
    <input type="password" class="form-control" name="password" required>
  </div>
  <button class="btn btn-primary w-100 mb-2">登录</button>
  <div class="text-center">
    <small>还没有账号？<a href="{% url 'users:register' %}">立即注册</a></small>
  </div>
</form>

<!-- 防止后退按钮导致CSRF问题的脚本 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 如果是通过后退按钮返回的，刷新页面获取新的CSRF令牌
    if (performance.navigation.type === 2) {
        // 延迟刷新，避免循环
        setTimeout(function() {
            location.reload();
        }, 100);
    }

    // 清除表单中的旧数据
    const form = document.querySelector('form');
    if (form) {
        form.reset();
    }
});
</script>
{% endblock %}